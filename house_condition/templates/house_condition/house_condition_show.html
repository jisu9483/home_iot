{% load static %}

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html lang="ko" xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="">
  <meta name="author" content="">
  <title>jisu's house condition</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"   integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
  <link href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i" rel="stylesheet">
  
  
  <script src="http://code.jquery.com/jquery-1.10.2.js"></script>
  <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
  <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
  <script src="http://code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

</head>
<script type="text/javascript">

function endJob(fn){
  fn.status = "end";
}

  function switchScreen() {
      document.getElementById("divLoading").style.display = "none";
      document.getElementById("wrapper").style.display = "";
  }
  </script>
  <script  src="https://cdn.jsdelivr.net/npm/chart.js@2.9.4/dist/Chart.min.js"></script>
<body id="page-top"  onload="switchScreen();">

  <div id="divLoading" style="position:absolute; top:35%; left:0; width:100%; text-align:center; margin:0 auto;">
      <img src="" alt="잠시만 기다려 주세요. 로딩중입니다." />
  </div>
  <div id="wrapper"  style="display:none;">
        <div class="container-fluid">
            <div class="row">
                <div style="width: 50%;">
                    <canvas id="temperature-chart"  style="height:300px;"></canvas>
                </div>
                <div style="width: 50%;">
                     <canvas id="humidity-chart" style="height:300px;"></canvas>
                </div>
            </div>
      <footer class="sticky-footer bg-white">
        <div class="container my-auto">
          <div class="copyright text-center my-auto">
            <span>Copyright &copy; Jisu's home 2021 ~ </span>
          </div>
        </div>
      </footer>
    </div>

  </div>

<script type="text/javascript">

// 그래프 data 가공
date = [];
temperature = [];
humidity = [];

var dataset = {{ data|safe }};

for(var i = 0; i < dataset.length; i++){
  date.push(dataset[i]['record_time']);
  temperature.push(dataset[i]['temperature']);
  humidity.push(dataset[i]['humidity']);
}
temperature_graph();
humidity_graph();

// 온도 그래프
function temperature_graph(){
  var ctx = document.getElementById('temperature-chart').getContext("2d");
  var temperatureChart = new Chart(ctx, {
      type: 'line',
      data: {
          labels: date,
          datasets: [{
              label: '온도',
              data: temperature,
              backgroundColor: "#4e73df",
              hoverBackgroundColor: "#2e59d9",
              borderColor: "#4e73df",
          }]
      },
      options: {
        animation: {
        duration: 1,
        onComplete: function () {
          var chartInstance = this.chart,
          ctx = chartInstance.ctx;
          ctx.font = Chart.helpers.fontString(Chart.defaults.global.defaultFontSize, Chart.defaults.global.defaultFontStyle, Chart.defaults.global.defaultFontFamily);
          ctx.textAlign = 'center';
          ctx.textBaseline = 'bottom';

          this.data.datasets.forEach(function (dataset, i) {
          var meta = chartInstance.controller.getDatasetMeta(i);
          meta.data.forEach(function (bar, index) {
          var data = dataset.data[index];                            
          ctx.fillText(data, bar._model.x, bar._model.y - 5);
              });
            });
          }
        },
        responsiveAnimationDuration: 100,
        responsive: true,
        legend: {
            display: true,
        },
        scales:{
          xAxes:[{
            ticks:{
              fontSize : 13
            },  
          }],
          yAxes: [{ 
            gridLines: { 
              drawBorder: false
            }, 
            ticks: {
              beginAtZero: true,
              suggestedMax: getMaxOfArray(temperature) + 5,
              callback: function (value, index, values) {
                  return addCommas(value);
              }
            }
          }]
          
        },
        showValue:{ fontStyle: 'Helvetica', fontSize:20}
        },
  });
}
// 습도 그래프
function humidity_graph(){
  var ctx = document.getElementById('humidity-chart');
  var shipaddressChart = new Chart(ctx, {
      type: 'line',
      data: {
          labels: date,
          datasets: [{
              label: '습도',
              data: humidity,
              backgroundColor: "#FF9900",
              hoverBackgroundColor: "#2e59d9",
              borderColor: "#FF9900",
          }]
      },
      options: {
        animation: {
        duration: 1,
        onComplete: function () {
          var chartInstance = this.chart,
          ctx = chartInstance.ctx;
          ctx.font = Chart.helpers.fontString(Chart.defaults.global.defaultFontSize, Chart.defaults.global.defaultFontStyle, Chart.defaults.global.defaultFontFamily);
          ctx.textAlign = 'center';
          ctx.textBaseline = 'bottom';

          this.data.datasets.forEach(function (dataset, i) {
          var meta = chartInstance.controller.getDatasetMeta(i);
          meta.data.forEach(function (bar, index) {
          var data = dataset.data[index];                            
          ctx.fillText(data, bar._model.x, bar._model.y - 5);
              });
            });
          }
        },
        responsiveAnimationDuration: 100,
        responsive: true,
        legend: {
            display: true,
        },
        scales:{
          xAxes:[{
            ticks:{
              fontSize : 13
            },  
          }],
          yAxes: [{ 
            gridLines: { 
              drawBorder: false
            }, 
            ticks: {
              beginAtZero: true,
              suggestedMax: getMaxOfArray(humidity) + 5,
              callback: function (value, index, values) {
                  return addCommas(value);
              }
            }
          }]
        },
      }
      
  });
}

function addCommas(nStr)
{
    nStr += '';
    x = nStr.split('.');
    x1 = x[0];
    x2 = x.length > 1 ? '.' + x[1] : '';
    var rgx = /(\d+)(\d{3})/;
    while (rgx.test(x1)) {
        x1 = x1.replace(rgx, '$1' + ',' + '$2');
    }
    return x1 + x2;
}
function getMaxOfArray(numArray) {
  return Math.max.apply(null, numArray);
}
</script>
</body>

</html>